<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<title>채팅방</title>
	<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
	<style>
		body { font-family: Arial, sans-serif; padding: 20px; }
		h2 { text-align: center; }
		#chat-box {
			border: 1px solid #ccc;
			height: 400px;
			overflow-y: auto;
			padding: 10px;
			margin-bottom: 10px;
			display: flex;
			flex-direction: column;
		}
		.msg { margin: 8px 0; }
		.msg-content { display: flex; align-items: flex-start; }
		.msg img {
			width: 32px; height: 32px; border-radius: 50%; margin-right: 8px;
		}
		.msg .nickname { font-weight: bold; color: #007bff; margin-bottom: 2px; }
		#message { width: 70%; padding: 8px; }
		#send-btn { padding: 8px 16px; background: #28a745; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
		#send-btn:hover { background: #1e7e34; }
	</style>
</head>
<body>
<h2>스터디 채팅방</h2>
<div id="chat-box"></div>

<input type="text" id="message" placeholder="메시지를 입력하세요"/>
<button id="send-btn">전송</button>

<script>
	let stompClient = null;
	const params = new URLSearchParams(window.location.search);
	const studyId = params.get("studyId");
	const token = localStorage.getItem("accessToken");
	
	let oldestMessageId = null;   // 현재까지 불러온 가장 오래된 메시지 ID
	let noMoreHistory = false;    // 더 이상 불러올 메시지가 없을 때 true
	const chatBox = document.getElementById("chat-box");
	
	// 메시지 렌더링
	function renderMessage(msg, position = "append") {
		const div = document.createElement("div");
		div.classList.add("msg");
		
		div.innerHTML = `
            <div class="msg-content">
                <img src="${msg.profileImageUrl || '/default-profile.png'}" alt="profile">
                <div>
                    <div class="nickname">${msg.nickname}</div>
                    <div>${msg.content}</div>
                </div>
            </div>
        `;
		
		if (position === "append") {
			chatBox.appendChild(div);
		} else {
			chatBox.insertBefore(div, chatBox.firstChild);
		}
	}
	
	// 히스토리 불러오기
	function loadHistory(initial = false) {
		if (noMoreHistory) return Promise.resolve();
		
		let url = `/api/studies/${studyId}/chatMessages?limit=50`;
		if (oldestMessageId && !initial) {
			url += `&lastMessageId=${oldestMessageId}`;
		}
		
		return fetch(url, {
			method: "GET",
			headers: { "Authorization": "Bearer " + token }
		})
				.then(res => res.json())
				.then(messages => {
					if (messages.length === 0) {
						noMoreHistory = true;
						return;
					}
					
					// 가장 오래된 메시지 ID 저장 (커서 갱신)
					oldestMessageId = messages[messages.length - 1].id;
					
					if (initial) {
						// 초기 로딩: 최신→오래된 → reverse 해서 append
						messages.reverse().forEach(msg => renderMessage(msg, "append"));
						chatBox.scrollTop = chatBox.scrollHeight;
					} else {
						// 추가 로딩: 그대로 prepend
						messages.forEach(msg => renderMessage(msg, "prepend"));
					}
				});
	}
	
	// 실시간 연결
	function connect() {
		const socket = new SockJS("http://localhost:8080/ws-stomp");
		stompClient = Stomp.over(socket);
		
		stompClient.connect({ Authorization: "Bearer " + token }, function (frame) {
			console.log("Connected: " + frame);
			
			stompClient.subscribe("/sub/studies/" + studyId, function (message) {
				const body = JSON.parse(message.body);
				renderMessage(body, "append");
				chatBox.scrollTop = chatBox.scrollHeight;
			});
		});
	}
	
	// 메시지 전송
	function sendMessage() {
		const msg = document.getElementById("message").value.trim();
		if (!msg) return;
		
		stompClient.send(
				"/pub/studies/" + studyId,
				{ Authorization: "Bearer " + token },
				JSON.stringify({ content: msg })
		);
		document.getElementById("message").value = "";
	}
	
	// 무한 스크롤 (맨 위 닿으면 이전 로그 로드)
	chatBox.addEventListener("scroll", () => {
		if (chatBox.scrollTop === 0 && !noMoreHistory) {
			const prevHeight = chatBox.scrollHeight;
			loadHistory(false).then(() => {
				chatBox.scrollTop = chatBox.scrollHeight - prevHeight;
			});
		}
	});
	
	// 초기 실행
	window.onload = () => {
		loadHistory(true).then(connect);
	};
	
	document.getElementById("send-btn").addEventListener("click", sendMessage);
	document.getElementById("message").addEventListener("keydown", function (event) {
		if (event.key === "Enter") {
			sendMessage();
		}
	});
</script>
</body>
</html>
